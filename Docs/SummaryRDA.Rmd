---
title: "Summary of RDA analysis"
author: "Shun Hasegawa"
date: "Saturday, February 14, 2015"
output: pdf_document
---

Here's the summary of redundancy analysis (RDA). I performed RDA for the whole data set, but due to huge spatial variation before the commencement of CO2 treatments, eCO2 effects are not very clear. So I also run RDA for 1) 2013 and 2014 separtely and saw the difference between CO2 treatments in each year, and 2) ambient and eCO2 separately and saw the difference between 2013 and 2014 in each treatments.

In addition to species composition, I also assessed plant functional gorup (PFG) composition by RDA.

```{r, echo=FALSE, results='hide', include=FALSE}
source("../R/Packages.R")
source("../R/functions.R")
################
# Process Data #
################
# source("R/FACE.vegetation.2014.management.R")

# Raw data for multi variate analysis
load("../output/Data//FACE_Vegetation_Raw.RData")

# Data frame with plant functional groups
load("../output//Data//FACE_Vegetation_PFG.RData")

# remove unknown spp
veg <- FACE.veg.rslt[!grepl("Unknown", FACE.veg.rslt$variable), ]

# co2, block and id
veg <- within(veg, {
  block <- recode(ring, "1:2 = 'A'; 3:4 = 'B'; 5:6 = 'C'")
  co2 <- factor(ifelse(ring %in% c(1, 4, 5), "elev", "amb"))
  id <- ring:plot
})

# organise data frame
veg.face <- within(veg.face, {
  co2 = factor(ifelse(ring %in% c(1, 4, 5), "elev", "amb"))
})
SiteName <- c("year", "ring", "co2", "plot", "position", "cell")
SppName <- names(veg.face)[!names(veg.face) %in% SiteName]

# plot sum
PlotSumVeg <- ddply(veg.face, .(year, co2, ring, plot), function(x) colSums(x[, SppName]))

# ring sum
RingSumVeg <- ddply(PlotSumVeg, .(year, co2, ring), function(x) colSums(x[, SppName]))
````

# Species composition

## Each year separately

```{r, echo=FALSE, results='markup'}
########################
# Redundancey analysis #
########################

###############
# All species #
###############

# each year separately----
rdaList <- dlply(RingSumVeg, .(year), function(x) rda(log(x[, SppName] + 1) ~ co2, data = x))

par(mfrow = c(1, 2))
l_ply(names(rdaList), function(x) plot(rdaList[[x]], main = x))
````

## Each CO2 treatment separately

```{r, echo=FALSE, results='markup'}
# each co2 treatment separately----
rdaList_year <- dlply(RingSumVeg, .(co2), function(x) rda(log(x[, SppName] + 1) ~ year, data = x))

par(mfrow = c(1, 2))
l_ply(names(rdaList_year), function(x) plot(rdaList_year[[x]], main = x))
````

Here are the species showting highest or lower three species scores.

```{r, echo=FALSE, results='markup'}
Smmry_rdaList_year <- llply(rdaList_year, summary)

llply(Smmry_rdaList_year, function(x){
  spsc <- x$species[, 1]
  sort(spsc)[c(1:3, 70:72)]
})
```

Similar species contributed to yearly change of species compositions at both CO2 treatmetns, but slightly different.

## All data together
```{r, echo=FALSE, results='markup'}
# two years together----
RingSumVeg$yco <- RingSumVeg$year:RingSumVeg$co2

RDAres <- rda(log(RingSumVeg[, SppName] + 1) ~ yco, data = RingSumVeg[, !names(RingSumVeg) %in% SppName])
RDAres <- rda(RingSumVeg[, SppName] ~ yco, data = RingSumVeg[, !names(RingSumVeg) %in% SppName])
RDAres
plot(RDAres)
```

# Plant functional groups

```{r, echo=FALSE, results='markup', include=FALSE}
#######
# PFG #
#######

# PFG matrix
RingSumPFGMatrix <- dcast(year + co2 + ring ~ PFG, data = subset(veg, !is.na(PFG)), sum)

# remove lichen and wood, also add interaction term
RingSumPFGMatrix <- within(RingSumPFGMatrix, {
  Lichen = NULL
  wood = NULL
  c3_4 = NULL
  yco = year:co2
})

# rda
PFGName <- c("c3", "c4", "legume", "moss", "Non_legume")
````

## Each year separately

```{r, echo=FALSE, results='markup'}
# each year separately----
pfg_co2 <- dlply(RingSumPFGMatrix, .(year), function(x) rda(log(x[, PFGName] + 1) ~ co2, data = x))
par(mfrow = c(1, 2))
l_ply(names(pfg_co2), function(x) plot(pfg_co2[[x]], main = x))
```

## Each CO2 treatment separately

```{r, echo=FALSE, results='markup'}
# each co2 treatment separately----
pfg_year <- dlply(RingSumPFGMatrix, .(co2), function(x) rda(log(x[, PFGName] + 1) ~ year, data = x))
par(mfrow = c(1, 2))
l_ply(names(pfg_year), function(x) plot(pfg_year[[x]], main = x))
````

PFG composition seems to have chagne more at ambeint than eCO2. Replot RDA1 values in a nicer format.

```{r, echo=FALSE, results='markup', message=FALSE}
SmmryPfgYear <- llply(pfg_year, summary)
PfgYearSitedf <- ldply(names(SmmryPfgYear), function(x) {
  data.frame(rda1 = SmmryPfgYear[[x]]$sites[, 1],
             subset(RingSumPFGMatrix, co2 == x)[, c("year", "ring", "co2")])})
PfgYearSitedf <- within(PfgYearSitedf, {
  co2 <- factor(co2, labels = c("Ambient RDA(7.9%)", 
                                "eCO2 RDA(4.1%)"))
  year <- factor(year, labels = c("2013\nPre-CO2", "2014"))
})

PfgYearSppdf <- ldply(names(SmmryPfgYear), function(x) {
  data.frame(rda1 = SmmryPfgYear[[x]]$species[, 1], 
             PFG = row.names(SmmryPfgYear[[x]]$species),
             co2 = x, 
             year = "Species score\nx5")})
PfgYearSppdf$co2 <- factor(PfgYearSppdf$co2, labels = c("Ambient RDA(7.9%)", "eCO2 RDA(4.1%)"))

theme_set(theme_bw())
p <- ggplot(PfgYearSitedf, aes(x = year, y = rda1))
p2 <- p + geom_point(aes(shape = year), size = 5, alpha = .7) + 
  geom_line(aes(group = ring), linetype = 3) + 
  geom_point(data = PfgYearSppdf, aes(x = year, y = rda1 * 5, col = PFG), 
             size = 5, alpha = .7, position = position_dodge(.5)) +
  facet_grid(~co2) +
  labs(x = NULL, y = "RDA1") +
  geom_hline(aes(yintercept = 0), linetype = "dashed", alpha = .7)
p2
```
The differences are subtle; however, at Ambient C4 grass increased, but not in eCO2 which is consistent with the analysis of the ratio of C3:C4. 

## All together

```{r, echo=FALSE, results='markup'}
# two years together----
PFGrdaRes <- rda(log(RingSumPFGMatrix[, PFGName] + 1) ~ yco, data = RingSumPFGMatrix)
PFGrdaRes
plot(PFGrdaRes)
```
